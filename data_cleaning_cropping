{"cells":[{"cell_type":"code","execution_count":null,"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"executionInfo":{"elapsed":4003,"status":"ok","timestamp":1701198045874,"user":{"displayName":"dummy dummy","userId":"06969951796983975917"},"user_tz":-330},"id":"YB4SAn_hvoFx","outputId":"62996cd6-27a6-48b0-cd2e-d6cf9404126e"},"outputs":[{"output_type":"stream","name":"stdout","text":["Drive already mounted at /content/drive; to attempt to forcibly remount, call drive.mount(\"/content/drive\", force_remount=True).\n"]}],"source":["from google.colab import drive\n","drive.mount('/content/drive')"]},{"cell_type":"code","execution_count":null,"metadata":{"id":"z3etMFbwzb4d"},"outputs":[],"source":["import numpy as np\n","import pandas as pd\n","import matplotlib.image as mpimg\n","from skimage.transform import resize\n","from PIL import Image\n","import warnings\n","\n","warnings.filterwarnings(\"ignore\", category=DeprecationWarning)\n","\n","\n","def crop_and_filter_image_with_padding(path, save_path, target_rgb=(75, 37, 141), tolerance=10, padding=10):\n","\n","\n","    try:\n","\n","      img = mpimg.imread(path)\n","      x = []\n","      y = []\n","\n","      # Find pixels within the specified RGB range\n","      for i in range(img.shape[0]):\n","          for j in range(img.shape[1]):\n","              pixel_rgb = img[i, j, :]\n","              if np.all(np.abs(pixel_rgb - target_rgb) <= tolerance):\n","                  x.append(i)\n","                  y.append(j)\n","\n","      df = pd.DataFrame(list(zip(x, y)))\n","\n","      # IQR filtering for both x and y coordinates\n","      for col in df.columns:\n","          Q1 = np.percentile(df[col], 25, interpolation='midpoint', method='linear')\n","          Q3 = np.percentile(df[col], 75, interpolation='midpoint', method='linear')\n","          IQR = Q3 - Q1\n","\n","          upper = np.where(df[col] >= (Q3 + 1.5 * IQR))\n","          lower = np.where(df[col] <= (Q1 - 1.5 * IQR))\n","\n","          df.drop(upper[0], inplace=True)\n","          df.drop(lower[0], inplace=True)\n","          df = df.reset_index(drop=True)\n","\n","      # Get the bounding box of the filtered coordinates with padding\n","      xmin = max(min(df[0]) - padding, 0)\n","      xmax = min(max(df[0]) + padding, img.shape[0])\n","      ymin = max(min(df[1]) - padding, 0)\n","      ymax = min(max(df[1]) + padding, img.shape[1])\n","\n","      # Crop the image using the bounding box with padding\n","      cropped_img = img[int(xmin):int(xmax), int(ymin):int(ymax)]\n","      resized_image = (resize(cropped_img, (80, 80, 3), mode='reflect', anti_aliasing=True) * 255).astype(np.uint8)\n","      Image.fromarray(resized_image).save(save_path)\n","    except:\n","      print(path)\n"]},{"cell_type":"code","execution_count":null,"metadata":{"id":"EcFJ1-Hhv6gb"},"outputs":[],"source":["import os\n","from tqdm import tqdm\n","\n","\n","def iterate_folders_and_files(main_folder,new_folder):\n","    # Iterate over each subfolder in the main folder\n","\n","    for root, dirs, files in os.walk(main_folder):\n","        sub_new_folder = new_folder+\"/\"+root.split(\"/\")[-1]\n","        os.makedirs(sub_new_folder, exist_ok=True)\n","        c = 0\n","        # Iterate over each file in the current subfolder\n","        for file in tqdm(files,desc = sub_new_folder):\n","            file_path = os.path.join(root, file)\n","            crop_and_filter_image_with_padding(file_path,os.path.join(sub_new_folder,file))\n","            c += 1\n","\n"]},{"cell_type":"code","execution_count":null,"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"MR8sLOC4AbNx","outputId":"b4654e01-d84f-4a26-f19f-bb7cafe7eee8","executionInfo":{"status":"ok","timestamp":1701205475432,"user_tz":-330,"elapsed":5899223,"user":{"displayName":"dummy dummy","userId":"06969951796983975917"}}},"outputs":[{"metadata":{"tags":null},"name":"stderr","output_type":"stream","text":["drive/My Drive/Raabin - WBC/crop_dataset/: 0it [00:00, ?it/s]\n","drive/My Drive/Raabin - WBC/crop_dataset/lymphocyte:  58%|█████▊    | 682/1181 [16:17<11:51,  1.43s/it]"]},{"metadata":{"tags":null},"name":"stdout","output_type":"stream","text":["drive/My Drive/Raabin - WBC/dataset/lymphocyte/LY_762686.jpg\n"]},{"metadata":{"tags":null},"name":"stderr","output_type":"stream","text":["drive/My Drive/Raabin - WBC/crop_dataset/lymphocyte:  78%|███████▊  | 919/1181 [21:58<06:27,  1.48s/it]"]},{"metadata":{"tags":null},"name":"stdout","output_type":"stream","text":["drive/My Drive/Raabin - WBC/dataset/lymphocyte/LY_915675.jpg\n"]},{"metadata":{"tags":null},"name":"stderr","output_type":"stream","text":["drive/My Drive/Raabin - WBC/crop_dataset/lymphocyte:  86%|████████▋ | 1021/1181 [24:13<03:28,  1.30s/it]"]},{"metadata":{"tags":null},"name":"stdout","output_type":"stream","text":["drive/My Drive/Raabin - WBC/dataset/lymphocyte/LY_147262.jpg\n"]},{"output_type":"stream","name":"stderr","text":["drive/My Drive/Raabin - WBC/crop_dataset/lymphocyte: 100%|██████████| 1181/1181 [27:39<00:00,  1.41s/it]\n","drive/My Drive/Raabin - WBC/crop_dataset/neutrophil:  77%|███████▋  | 1151/1500 [25:09<07:31,  1.30s/it]"]},{"output_type":"stream","name":"stdout","text":["drive/My Drive/Raabin - WBC/dataset/neutrophil/SNE_242915.jpg\n"]},{"output_type":"stream","name":"stderr","text":["drive/My Drive/Raabin - WBC/crop_dataset/neutrophil: 100%|██████████| 1500/1500 [32:44<00:00,  1.31s/it]\n","drive/My Drive/Raabin - WBC/crop_dataset/eosinophil:  10%|█         | 157/1500 [03:48<28:20,  1.27s/it]"]},{"output_type":"stream","name":"stdout","text":["drive/My Drive/Raabin - WBC/dataset/eosinophil/EO_72747.jpg\n"]},{"output_type":"stream","name":"stderr","text":["drive/My Drive/Raabin - WBC/crop_dataset/eosinophil:  46%|████▌     | 683/1500 [15:16<17:35,  1.29s/it]"]},{"output_type":"stream","name":"stdout","text":["drive/My Drive/Raabin - WBC/dataset/eosinophil/EO_882216.jpg\n"]},{"output_type":"stream","name":"stderr","text":["drive/My Drive/Raabin - WBC/crop_dataset/eosinophil:  75%|███████▌  | 1132/1500 [25:02<08:19,  1.36s/it]"]},{"output_type":"stream","name":"stdout","text":["drive/My Drive/Raabin - WBC/dataset/eosinophil/EO_581610.jpg\n"]},{"output_type":"stream","name":"stderr","text":["drive/My Drive/Raabin - WBC/crop_dataset/eosinophil:  98%|█████████▊| 1468/1500 [32:15<00:42,  1.32s/it]"]},{"output_type":"stream","name":"stdout","text":["drive/My Drive/Raabin - WBC/dataset/eosinophil/EO_669624.jpg\n"]},{"output_type":"stream","name":"stderr","text":["drive/My Drive/Raabin - WBC/crop_dataset/eosinophil:  99%|█████████▉| 1482/1500 [32:33<00:23,  1.28s/it]"]},{"output_type":"stream","name":"stdout","text":["drive/My Drive/Raabin - WBC/dataset/eosinophil/EO_68346.jpg\n"]},{"output_type":"stream","name":"stderr","text":["drive/My Drive/Raabin - WBC/crop_dataset/eosinophil: 100%|██████████| 1500/1500 [32:57<00:00,  1.32s/it]\n","drive/My Drive/Raabin - WBC/crop_dataset/monocyte:   7%|▋         | 95/1372 [02:33<26:51,  1.26s/it]"]},{"output_type":"stream","name":"stdout","text":["drive/My Drive/Raabin - WBC/dataset/monocyte/MO_385446.jpg\n"]},{"output_type":"stream","name":"stderr","text":["drive/My Drive/Raabin - WBC/crop_dataset/monocyte:  12%|█▏        | 165/1372 [04:03<24:51,  1.24s/it]"]},{"output_type":"stream","name":"stdout","text":["drive/My Drive/Raabin - WBC/dataset/monocyte/MO_403840.jpg\n"]},{"output_type":"stream","name":"stderr","text":["drive/My Drive/Raabin - WBC/crop_dataset/monocyte:  18%|█▊        | 252/1372 [05:57<24:56,  1.34s/it]"]},{"output_type":"stream","name":"stdout","text":["drive/My Drive/Raabin - WBC/dataset/monocyte/MO_499702.jpg\n"]},{"output_type":"stream","name":"stderr","text":["drive/My Drive/Raabin - WBC/crop_dataset/monocyte:  19%|█▊        | 254/1372 [06:00<25:14,  1.35s/it]"]},{"output_type":"stream","name":"stdout","text":["drive/My Drive/Raabin - WBC/dataset/monocyte/MO_521254.jpg\n"]},{"output_type":"stream","name":"stderr","text":["drive/My Drive/Raabin - WBC/crop_dataset/monocyte:  27%|██▋       | 374/1372 [08:37<22:06,  1.33s/it]"]},{"output_type":"stream","name":"stdout","text":["drive/My Drive/Raabin - WBC/dataset/monocyte/MO_590262.jpg\n"]},{"output_type":"stream","name":"stderr","text":["drive/My Drive/Raabin - WBC/crop_dataset/monocyte:  39%|███▉      | 537/1372 [12:11<18:18,  1.32s/it]"]},{"output_type":"stream","name":"stdout","text":["drive/My Drive/Raabin - WBC/dataset/monocyte/MO_672954.jpg\n"]},{"output_type":"stream","name":"stderr","text":["drive/My Drive/Raabin - WBC/crop_dataset/monocyte:  53%|█████▎    | 723/1372 [16:17<14:22,  1.33s/it]"]},{"output_type":"stream","name":"stdout","text":["drive/My Drive/Raabin - WBC/dataset/monocyte/MO_810901.jpg\n"]},{"output_type":"stream","name":"stderr","text":["drive/My Drive/Raabin - WBC/crop_dataset/monocyte:  59%|█████▊    | 804/1372 [18:02<12:11,  1.29s/it]"]},{"output_type":"stream","name":"stdout","text":["drive/My Drive/Raabin - WBC/dataset/monocyte/MO_864818.jpg\n"]},{"output_type":"stream","name":"stderr","text":["drive/My Drive/Raabin - WBC/crop_dataset/monocyte:  65%|██████▌   | 898/1372 [20:04<09:57,  1.26s/it]"]},{"output_type":"stream","name":"stdout","text":["drive/My Drive/Raabin - WBC/dataset/monocyte/MO_92432.jpg\n"]},{"output_type":"stream","name":"stderr","text":["drive/My Drive/Raabin - WBC/crop_dataset/monocyte:  69%|██████▊   | 941/1372 [21:00<09:05,  1.27s/it]"]},{"output_type":"stream","name":"stdout","text":["drive/My Drive/Raabin - WBC/dataset/monocyte/MO_983541.jpg\n"]},{"output_type":"stream","name":"stderr","text":["drive/My Drive/Raabin - WBC/crop_dataset/monocyte:  69%|██████▉   | 951/1372 [21:13<09:10,  1.31s/it]"]},{"output_type":"stream","name":"stdout","text":["drive/My Drive/Raabin - WBC/dataset/monocyte/MO_980470.jpg\n"]},{"output_type":"stream","name":"stderr","text":["drive/My Drive/Raabin - WBC/crop_dataset/monocyte:  79%|███████▉  | 1087/1372 [24:10<06:05,  1.28s/it]"]},{"output_type":"stream","name":"stdout","text":["drive/My Drive/Raabin - WBC/dataset/monocyte/MO_187660.jpg\n"]},{"output_type":"stream","name":"stderr","text":["drive/My Drive/Raabin - WBC/crop_dataset/monocyte:  92%|█████████▏| 1265/1372 [28:01<02:15,  1.27s/it]"]},{"output_type":"stream","name":"stdout","text":["drive/My Drive/Raabin - WBC/dataset/monocyte/MO_257939.jpg\n"]},{"output_type":"stream","name":"stderr","text":["\rdrive/My Drive/Raabin - WBC/crop_dataset/monocyte:  92%|█████████▏| 1266/1372 [28:02<02:16,  1.28s/it]"]},{"output_type":"stream","name":"stdout","text":["drive/My Drive/Raabin - WBC/dataset/monocyte/MO_248568.jpg\n"]},{"output_type":"stream","name":"stderr","text":["drive/My Drive/Raabin - WBC/crop_dataset/monocyte: 100%|██████████| 1372/1372 [30:19<00:00,  1.33s/it]\n"]}],"source":["iterate_folders_and_files('drive/My Drive/Raabin - WBC/dataset/','drive/My Drive/Raabin - WBC/crop_dataset')"]}],"metadata":{"accelerator":"GPU","colab":{"machine_shape":"hm","provenance":[],"gpuType":"A100","authorship_tag":"ABX9TyMVLGiDJG/GsGzibVfLGU8E"},"kernelspec":{"display_name":"Python 3","name":"python3"},"language_info":{"name":"python"}},"nbformat":4,"nbformat_minor":0}